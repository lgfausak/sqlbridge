<html>
<head>
<title>Simple Autobahn SQLBridge</title>
<script src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz">
</script>
<script language="Javascript">
var my_session;
var connection = new autobahn.Connection({
         url: 'ws://192.168.200.87:8080/ws',
         realm: 'realm1'
      });

connection.onopen = function (session) {

   my_session = session;
   // 1) subscribe to a topic
   function onevent(args) {
      console.log("Event:", args[0]);
   }
   session.subscribe('com.myapp.hello', onevent);

   // 2) publish an event
   session.publish('com.myapp.hello', ['Hello, world!']);

   // 3) register a procedure for remoting
   function add2(args) {
      return args[0] + args[1];
   }
   session.register('com.myapp.add2', add2);
};

connection.open();

function doit() {
   // 4) call a remote procedure
   query = document.getElementById('query').value;
   try {
      args = JSON.parse(document.getElementById('args').value);
   } catch(err) {
      args = {};
   }

   console.log("run query ", query);

   abcall = 'com.db.' + document.getElementById("abcall").value;

   my_session.call(abcall, [ query, args ] ).then(
      function (res) {
         console.log("Result:", res);
	 if(res) {
	    tbtext = "<table>";
	    tbtext += "<theader>";
	    ri = res[0]
	    for(j in ri) {
	       if(!ri.hasOwnProperty(j)) {
	          continue;
	       }
	       tbtext += "<th>";
	       tbtext += j;
	       tbtext += "</th>";
	    }
	    tbtext += "</theader>";
	    tbtext += "<tbody>";
            for(i = 0; i < res.length; i++) {
              ri = res[i];
	      tbtext += "<tr>";
	      for(j in ri) {
	         if(!ri.hasOwnProperty(j)) {
	            continue;
	         }
	         tbtext += "<td>";
	         tbtext += ri[j];
	         tbtext += "</td>";
	      }
	      tbtext += "</tr>";
            }
	    tbtext += "</tbody>";
	    tbtext += "</table>";
            document.getElementById("result").innerHTML = tbtext;
	 }
         tbtext = "<p>Autobahn call: " + abcall + "</p>";
         tbtext += "<p>Query: " + query + "</p>";
         tbtext += "<p>Args: " + JSON.stringify(args) + "</p>";
         document.getElementById("rpc").innerHTML = tbtext;
      },
      function(error) {
	 console.log(JSON.stringify(error));
         document.getElementById("rpc").innerHTML = "Error : " + JSON.stringify(error);
      }
   )
}

</script>
</head>
<body>
<form name="f1">
  <p>type:
  <select id="abcall">
    <option value="query">query (results are expected, like select)</option>>
    <option value="operation">operation (no results expected, like delete from)</option>>
    <option value="watch">watch (only valid for postgres databases)</option>>
  </select></p>
  <p>query: <textarea rows="6" cols="60" id="query" name="query"></textarea></p>
  <p>args (json format): <input size="60" id="args" name="args" type="text"/>  </p>
  <p><input value="Go" type="button" onclick='JavaScript:doit()'/></p>
  <hr/>
  <div id="rpc"></div>
  <hr/>
  <div id="result"></div>
  <hr/>
</form>
</body>
</html>
